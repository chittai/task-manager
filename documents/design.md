# TaskManager 機能要件定義書 (**v1.4**)

## 1. 概要

本ドキュメントは、TaskManager アプリケーションの機能要件を定義するものである。
本アプリケーションは、ユーザーがタスクを管理するための Web アプリケーションであり、Getting Things Done (GTD) の考え方を取り入れ、効率的なタスク処理を支援するとともに、各タスクの対応履歴を記録・確認できることを目指す。

## 2. 機能要件

### 2.1. タスク表示機能

-   FR-001: 登録されているタスクの一覧を表示できること。(変更なし)
-   FR-002: 各タスクについて、以下の情報を表示または保持していること。
    -   タイトル (`title`)
    -   説明 (`description`)
    -   ステータス (`status`: 'inbox','todo', 'in-progress', 'done', 'wait-on' のいずれか。)
    -   優先度 (`priority`: 'low', 'medium', 'high' のいずれか)
    -   期限日 (`dueDate`, オプション)
    -   作成日時 (`createdAt`)
    -   更新日時 (`updatedAt`)
    -   プロジェクト (`projectId`, オプション、関連するプロジェクトID)
    -   コメントリスト (`comments`, オプション、Comment オブジェクトの配列)
-   FR-003: アプリケーション起動時やデータ読み込み中に、ローディング状態を示す表示を行うこと。
-   FR-004: タスク一覧をフィルタリング（例: コンテキスト別、プロジェクト別、ステータス別）できること。
-   FR-005: タスク一覧をソート（例: 期限日順、優先度順、作成日時順）できること。

### 2.2. タスク追加機能 (**GTD: 収集・処理フェーズ**)

-   FR-006: 新しいタスクを追加するためのインターフェース（例: クイック追加バー、モーダルウィンドウ）を提供すること。特に、未整理のアイデアやタスクを素早く「インボックス」に追加できること。
-   FR-007: タスク追加時に、以下の情報を入力できること。
    -   タイトル
    -   （オプション）説明
    -   （オプション）プロジェクト
    -   （オプション）ステータス (デフォルトは 'inbox')
    -   （オプション）優先度
    -   （オプション）期限日
-   FR-008: タスク追加時に、システムは以下を自動的に設定すること。
    -   一意のタスクID (`id`)
    -   作成日時 (`createdAt`)
    -   更新日時 (`updatedAt`)
-   FR-009: 追加されたタスクはタスク一覧（またはインボックス画面）に表示されること。

### 2.3. タスク編集・整理機能 (**GTD: 処理・整理フェーズ**)

-   FR-010: 既存のタスクを選択し、編集するためのインターフェース（モーダルウィンドウ）を提供すること。インボックス内のタスクを処理・整理する際にも使用する。
-   FR-011: タスク編集時に、以下の情報を変更できること。
    -   タイトル
    -   説明
    -   ステータス
    -   優先度
    -   期限日
    -   プロジェクト
-   FR-012: タスク編集時に、システムは更新日時 (`updatedAt`) を自動的に更新すること。
-   FR-013: 編集されたタスクの情報はタスク一覧に反映されること。

### 2.4. タスク削除機能

-   FR-014: 既存のタスクを選択し、削除できること。
-   FR-015: タスク削除前に、確認メッセージを表示すること。
-   FR-016: 削除されたタスクはタスク一覧から除去されること。

### 2.5. タスクステータス変更機能 (**GTD: 実行フェーズ**)

-   FR-017: タスク一覧画面などから、直接タスクのステータス ('todo', 'in-progress', 'done') を変更できること。
-   FR-018: ステータス変更時、システムは更新日時 (`updatedAt`) を自動的に更新すること。

### 2.6. データ永続化機能

-   FR-019: 作成・編集・削除されたタスク情報は、ブラウザを閉じたりリロードしたりしても保持されること (現時点ではブラウザの LocalStorage を使用)。

### 2.7. プロジェクト管理機能

-   FR-020: プロジェクトを作成、編集、削除できること。
-   FR-021: 各プロジェクトに属するタスクの一覧を表示できること。
-   FR-027: プロジェクト一覧ページ (`/projects`) を提供し、以下の機能を含むこと: (一部 Issue #44 で対応)
    -   登録されているすべてのプロジェクトを Cloudscape Design System の `Table` コンポーネントを使用して一覧表示する（表示項目例: プロジェクト名、説明、作成日時、更新日時）。
    -   ページヘッダー（またはテーブルヘッダーアクション）に「新規プロジェクト作成」ボタンを配置し、クリックするとプロジェクト作成モーダル (`ProjectModal.tsx`) を表示する。
    -   各プロジェクトの行に「編集」ボタンと「削除」ボタンを配置する。
        -   「編集」ボタン: 対応するプロジェクトのデータで `ProjectModal.tsx` を編集モードで表示する。
        -   「削除」ボタン: Cloudscape の確認モーダル（「本当に削除しますか？」等）を表示後、`useProjects` フックの `deleteProject` 関数を呼び出してプロジェクトを削除し、一覧を更新する。
    -   (TODO) テーブルのページネーション、フィルタリング、ソート、表示列のカスタマイズ機能 (Cloudscape CollectionPreferences)。
    -   (TODO) プロジェクト作成・編集・削除処理時のエラーハンドリングとユーザーへのフィードバック（例: Cloudscape Flashbar）。

### 2.8. タスク履歴・コメント機能

-   FR-022: 各タスクの詳細画面（またはモーダル内）で、コメントを追加するためのインターフェースを提供すること。
-   FR-023: コメント追加時には、コメント内容と共にシステムが自動的に追加日時（および可能であればユーザー情報）を記録すること。
-   FR-024: 各タスクに関連するコメントの履歴を、時系列（新しいものが上または下）で表示できること。

### 2.8.1. コメント編集・削除機能 (Issue #14)

-   FR-028: コメントの作成者が、自身のコメントを編集できること。
    -   編集時には、既存のコメント内容が入力された状態で編集フォームを表示する。
    -   編集後、コメント内容と更新日時を更新する。
-   FR-029: コメントの作成者が、自身のコメントを削除できること。
    -   削除時には、確認ダイアログを表示する。
    -   確認後、コメントを物理削除する。
-   FR-030: コメントの編集・削除UI（例: 編集ボタン、削除ボタン）は、各コメントに対して表示されること。

### 2.9. GTDレビュー支援機能

-   FR-026: 定期的なレビュー（週次レビューなど）をサポートする機能を提供すること（例: 特定のタグが付いたタスクの一覧表示、インボックス内の未処理タスクのリマインドなど）。

## 3. データモデル

本アプリケーションで利用する主要なデータモデルは以下の通りです。

### 3.1. Task

タスク情報を表します。

```typescript
interface Task {
  id: string; // 一意の識別子
  title: string; // タスクのタイトル
  description: string; // タスクの詳細説明
  status: 'inbox' | 'todo' | 'in-progress' | 'done' | 'wait-on'; // タスクのステータス
  priority: 'low' | 'medium' | 'high'; // タスクの優先度
  dueDate?: string; // 期限日 (ISO 8601 format, オプション)
  createdAt: string; // 作成日時 (ISO 8601 format)
  updatedAt: string; // 最終更新日時 (ISO 8601 format)
  projectId?: string; // 関連プロジェクトのID (オプション)
  comments?: Comment[]; // タスクに関連するコメントの配列 (オプション)
}
```

### 3.2. Comment

タスクへのコメント情報を表します。

```typescript
interface Comment {
  id: string; // 一意の識別子
  taskId: string; // 関連タスクのID
  content: string; // コメント内容
  createdAt: string; // 作成日時 (ISO 8601 format)
  userId?: string; // コメント作成者のID (オプション、v1.3時点では固定値 "localUser" などを想定)
  updatedAt?: string; // 最終更新日時 (ISO 8601 format, オプション)
}
```

### 3.3. Project

プロジェクト情報を表します。

```typescript
interface Project {
  id: string; // 一意の識別子
  name: string; // プロジェクト名
  description?: string; // プロジェクトの説明 (オプション)
  createdAt: string; // 作成日時 (ISO 8601 format)
  updatedAt: string; // 最終更新日時 (ISO 8601 format)
}
```

## 4. 主要コンポーネント/モジュール構成

### 4.1. モデル (src/models/)

-   `Task.ts`: タスクのデータ構造 (Task インターフェース) を定義します。
-   `Comment.ts`: コメントのデータ構造 (Comment インターフェース) を定義します。
-   `Project.ts`: プロジェクトのデータ構造 (Project インターフェース) を定義します。

### 4.2. フック (src/hooks/)

-   `useTasks.ts` (仮): タスクデータに関する状態管理とCRUD操作（LocalStorage利用）を提供します。(Issue #2 で実装予定)
-   `useProjects.ts`: プロジェクトデータに関する状態管理とCRUD操作（LocalStorage利用）を提供します。

### 4.3. UIコンポーネント (src/components/)

-   `TaskList.tsx` (仮): タスク一覧の表示と操作を行います。(Issue #2 で実装予定)
-   `TaskForm.tsx` (仮): タスクの追加・編集フォームを提供します。Issue #4 により、プロジェクト選択ドロップダウンが追加され、新規タスク作成時のデフォルトステータスが `'inbox'` に設定されるよう変更されました。また、既存タスク編集時にもプロジェクトとステータス（`'inbox'`, `'wait-on'` を含む全定義済みステータス）が選択可能です。
-   `ProjectList.tsx`: プロジェクト一覧の表示と管理（新規作成、編集、削除）を行う主要コンポーネント。
    -   目的: アプリケーション内の全プロジェクトを一覧表示し、ユーザーが各プロジェクトの管理（作成、編集、削除）を行えるようにする。
    -   機能:
        -   `useProjects` フックを利用してプロジェクトデータを取得し、表示する。
        -   Cloudscape Design System の `Table` コンポーネントを使用し、プロジェクト名、説明、作成日時、更新日時などの情報を表示する。
        -   テーブルヘッダーのアクションとして「新規プロジェクト作成」ボタンを配置。クリックすると `ProjectModal.tsx` を作成モードで表示する。
        -   テーブルの各行には、「編集」ボタンと「削除」ボタンを配置。
            -   「編集」ボタン: 対応するプロジェクトのデータで `ProjectModal.tsx` を編集モードで表示する。
            -   「削除」ボタン: Cloudscape の確認モーダル（「本当に削除しますか？」等）を表示後、`useProjects` フックの `deleteProject` 関数を呼び出してプロジェクトを削除し、一覧を更新する。
        -   (TODO) テーブルのページネーション、フィルタリング、ソート、表示列のカスタマイズ機能 (Cloudscape CollectionPreferences)。
        -   (TODO) プロジェクト作成・編集・削除処理時のエラーハンドリングとユーザーへのフィードバック（例: Cloudscape Flashbar）。
    -   UI は Cloudscape Design System のガイドラインに準拠する。
    -   関連Issue: #23 (データフック), #24 (モーダル), #44 (UI実装)
-   `ProjectModal.tsx`: プロジェクトの追加・編集を行うためのモーダルウィンドウを提供する。
    -   目的: 新規プロジェクトの作成、または既存プロジェクトの編集を行うための統一されたインターフェースを提供する。
    -   機能:
        -   Cloudscape Design System の `Modal` コンポーネントを使用する。
        -   モーダルのヘッダーは、作成時（例: 「新しいプロジェクト」）と編集時（例: 「プロジェクトを編集」）で動的に変更する。
        -   モーダルのボディ部分には `ProjectForm.tsx` コンポーネントを配置し、実際のフォーム入力と送信処理は `ProjectForm.tsx` に委譲する。
        -   フォーム送信時 (`onSubmit`) には、`useProjects` フックの `createProject` または `updateProject` 関数を呼び出す。
        -   キャンセルボタンまたはモーダルを閉じるアクションで、変更を保存せずにモーダルを閉じる。
    -   関連Issue: #24, #44
-   `ProjectForm.tsx`: プロジェクト作成・編集のためのフォームUIと基本的なバリデーションロジックを提供する。
    -   目的: `ProjectModal.tsx` から呼び出され、プロジェクト名と説明の入力フィールドを提供する。
    -   機能:
        -   Cloudscape Design System の `Form`, `FormField`, `Input` (プロジェクト名用), `Textarea` (説明用), `Button` (送信・キャンセル用) コンポーネントを使用する。
        -   プロジェクト名は必須入力とし、未入力の場合はエラーメッセージを表示する。
        -   説明は任意入力とする。
        -   「作成」または「保存」ボタンクリック時に `onSubmit` コールバックを呼び出し、入力されたプロジェクトデータを親コンポーネントに渡す。
        -   「キャンセル」ボタンクリック時に `onCancel` コールバックを呼び出す。
    -   関連Issue: #44
-   `TaskModal.tsx`: タスクの追加・編集、およびコメント表示・追加を行うためのモーダルウィンドウを提供します。Issue #3 および Issue #4 でUI更新を行いました。詳細は以下を参照。

    **TaskModal UI 更新 (Issue #3, #4) 詳細**

    **1. 現状の課題**
    - `TaskModal` 内にタスク編集フォーム (`TaskForm`) とコメント関連のUI (`CommentList`, `CommentForm`) が縦に長く配置されており、情報量が多い場合に一覧性が低い。
    - タスク編集とコメント確認・投稿という異なるコンテキストの操作が同一階層にあり、ユーザーが目的の操作に集中しづらい可能性がある。

    **2. 改善方針**
    - Cloudscape Design System の `Tabs` コンポーネントを導入し、モーダル内の情報を「タスク詳細」と「コメント」の2つのタブに明確に分離する。
    - これにより、ユーザーは一度に表示される情報量が整理され、目的の操作に集中しやすくなる。

    **3. UI設計（TaskModal）**

    *   **3.1. モーダル全体構造**
        - `Modal` コンポーネント (`@cloudscape-design/components`)
            - `header`: `title` プロパティ (例: "タスクを編集", "新しいタスク")
            - `visible`: `visible` プロパティ
            - `onDismiss`: `onDismiss` プロパティ
            - `footer`: (変更なし - `TaskForm` 内のボタンが引き続き利用される想定)
            - `size`: "medium" (現状維持)

    *   **3.2. タブ構成**
        - `Tabs` コンポーネント (`@cloudscape-design/components`) を `Modal` の直下に配置。
            - `tabs` プロパティに以下の2つのタブオブジェクトを定義する:
                1.  **「タスク詳細」タブ:**
                    *   `label`: "タスク詳細"
                    *   `id`: "task-details"
                    *   `content`: `TaskForm` コンポーネントを配置。
                        *   `onSubmit`: 親から渡される `onSubmit` をそのまま渡す。
                        *   `onCancel`: 親から渡される `onDismiss` をそのまま渡す（タブUIではモーダル自体を閉じるため）。
                        *   `initialValues`: `task` プロパティをそのまま渡す。
                        *   `submitButtonText`: `submitButtonText` プロパティをそのまま渡す。
                2.  **「コメント」タブ:**
                    *   `label`: "コメント"
                    *   `id`: "comments"
                    *   `content`:
                        *   `Header` コンポーネント (`variant="h3"`) で "コメント" という小見出しを表示。
                        *   `CommentForm` コンポーネント:
                            *   `onSubmit`: コメント追加処理のハンドラ (`handleAddComment`) を渡す。
                            *   Markdown入力対応: テキストエリア等でMarkdown形式の入力を受け付け、`react-markdown` 等のライブラリを使用して処理する。
                            *   プレビュー機能: 入力されたMarkdownのリアルタイムプレビュー、またはタブ/ボタン切り替えによるプレビュー機能を提供する。
                        *   `CommentList` コンポーネント:
                            *   `comments`: `task.comments || []` を渡す。
                            *   表示形式: 各コメントを視覚的に分離されたカード形式（枠線、背景、影などを利用）で表示する。
                            *   Markdownレンダリング: コメント本文をMarkdownとして解釈し、HTMLとしてレンダリングして表示する。
                            *   編集・削除機能: 各コメントに編集ボタンおよび削除ボタンを配置する。ユーザーは自身のコメントを編集・削除できる。
                                *   **所有者判定**: 当面は、コメントオブジェクトにクライアントサイドで識別可能なフラグ（例: `isOwnComment: true`）を付与するか、コメント追加時のローカルな状態と照合することで、自分のコメントであるかを簡易的に判定する。
                                *   **編集時**: 編集ボタンクリックで、対象コメントの内容が入力された編集フォーム（モーダルダイアログまたはインライン展開されるフォーム）を表示/有効化する。
                                *   **削除時**: 削除ボタンクリックで、実行前に確認ダイアログ（例: 「このコメントを削除しますか？」）を表示し、承認後に削除処理を実行する。
    *   **3.3. 状態管理**
        - `TaskModal` コンポーネント内で、現在アクティブなタブIDを管理するために `useState` フックを使用する (例: `[activeTabId, setActiveTabId] = useState('task-details')`)。
        - `Tabs` コンポーネントの `onChange` イベントで `activeTabId` を更新する。

    **4. 影響範囲**
    - `TaskModal.tsx`: 主な変更箇所。上記のUI構成を実装。
    - `TaskForm.tsx`: 基本的に変更なし。タブ内に配置されるだけ。
    - `CommentList.tsx`, `CommentForm.tsx`: 基本的に変更なし。タブ内に配置されるだけ。

### 4.4. コンテキスト (src/context/)

-   ~~`AuthContext.tsx`: (未実装だが Issue #14 で必要)~~~
    ~~    -   目的: アプリケーション全体でユーザー認証状態と現在のユーザー情報を管理・提供する。~~~
    ~~    -   機能:~~~
    ~~        -   ログイン状態（認証済みか否か）。~~~
    ~~        -   認証済みユーザーのID (`userId`) などの情報。（今回は `userId` のみを想定し、固定値または簡易的な入力で代替も可）~~~
    ~~        -   ログイン・ログアウト機能の提供（本Issueのスコープ外だが将来的な拡張）。~~~
    ~~    -   コメントの編集・削除権限の判定に `userId` を利用する。~~~

## 5. APIエンドポイント設計

本アプリケーションが利用するAPIエンドポイントの設計です。

### 5.1. タスク操作API

(既存のタスク関連APIがあればここに記述。なければ省略可)

### 5.2. プロジェクト操作API

(既存のプロジェクト関連APIがあればここに記述。なければ省略可)

### 5.3. コメント操作API

タスクに紐づくコメントの操作を行います。

#### 5.3.1. コメント追加

-   **エンドポイント:** `POST /api/tasks/:taskId/comments`
-   **リクエストボディ:**
    ```json
    {
      "text": "新しいコメント内容"
    }
    ```
-   **レスポンス (成功時):** 作成されたコメントオブジェクト
-   **レスポンス (失敗時):** エラー情報

#### 5.3.2. コメント更新

-   **エンドポイント:** `PUT /api/tasks/:taskId/comments/:commentId`
-   **リクエストボディ:**
    ```json
    {
      "text": "更新されたコメント内容"
    }
    ```
-   **レスポンス (成功時):** 更新後のコメントオブジェクト
-   **レスポンス (失敗時):** エラー情報

#### 5.3.3. コメント削除

-   **エンドポイント:** `DELETE /api/tasks/:taskId/comments/:commentId`
-   **レスポンス (成功時):** ステータスコード 204 (No Content) または成功メッセージ
-   **レスポンス (失敗時):** エラー情報

## 5. アプリケーション構造

本アプリケーションは、React と Cloudscape Design System を用いて構築されています。

### 5.1. ナビゲーション

-   アプリケーション全体のナビゲーションは、`src/App.tsx` 内で Cloudscape Design System の `AppLayout` コンポーネントと `SideNavigation` コンポーネントを使用して実現されています。
-   画面左側にサイドナビゲーションパネルが表示され、以下の主要ページへのリンクが提供されます:
    -   タスク一覧 (`/`)
    -   プロジェクト一覧 (`/projects`)
-   `react-router-dom` を利用してクライアントサイドルーティングを行い、ページ遷移を実現しています。
-   アクティブなページに応じて、サイドナビゲーションの対応するリンクがハイライトされます。

### 5.2. 状態管理

-   タスクデータ (`useTasks.ts`) およびプロジェクトデータ (`useProjects.ts`) は、それぞれカスタムフック内で `useState` と `useEffect` を用いて管理されています。
-   データ永続化は、現時点ではブラウザの LocalStorage を利用しています。

### 5.3. UIコンポーネント間の連携

-   一覧表示コンポーネント (`TaskList.tsx`, `ProjectList.tsx`) は、対応するカスタムフックからデータを取得し、テーブル形式で表示します。
-   作成・編集操作は、モーダルウィンドウ (`TaskModal.tsx`, `ProjectModal.tsx`) 内のフォームコンポーネント (`TaskForm.tsx`, `ProjectForm.tsx`) を通じて行われます。
-   フォーム送信時には、対応するカスタムフックの関数（例: `addTask`, `updateProject`）が呼び出され、データが更新されます。
